# Linux Audit Daemon - Log collection Rules
#
# U _____ u _   _     _____  U _____ u   ____      ____      ____                ____   U _____ u         _       _   _   ____              _____   ____    
# \| ___"|/| \ |"|   |_ " _| \| ___"|/U |  _"\ u U|  _"\ uU |  _"\ u     ___    / __"| u\| ___"|/     U  /"\  uU |"|u| | |  _"\    ___     |_ " _| |  _"\   
#  |  _|" <|  \| |>    | |    |  _|"   \| |_) |/ \| |_) |/ \| |_) |/    |_"_|  <\___ \/  |  _|" U  u   \/ _ \/  \| |\| |/| | | |  |_"_|      | |  /| | | |  
#  | |___ U| |\  |u   /| |\   | |___    |  _ <    |  __/    |  _ <       | |    u___) |  | |___ /___\  / ___ \   | |_| |U| |_| |\  | |      /| |\ U| |_| |\ 
#  |_____| |_| \_|   u |_|U   |_____|   |_| \_\   |_|       |_| \_\    U/| |\u  |____/>> |_____|__"__|/_/   \_\ <<\___/  |____/ uU/| |\u   u |_|U  |____/ u 
#  <<   >> ||   \\,-._// \\_  <<   >>   //   \\_  ||>>_     //   \\_.-,_|___|_,-.)(  (__)<<   >>       \\    >>(__) )(    |||_.-,_|___|_,-._// \\_  |||_    
# (__) (__)(_")  (_/(__) (__)(__) (__) (__)  (__)(__)__)   (__)  (__)\_)-' '-(_/(__)    (__) (__)     (__)  (__)   (__)  (__)_)\_)-' '-(_/(__) (__)(__)_)   
#                                                                                                                Â© Speranza Ranieri (sranieri@unisa.it)
#
# Based on rules published on https://github.com/linux-audit/audit-userspace/tree/master/rules (Commit: 8ed522a)
# Creation date: 03/02/2026

# #######################################
# Reset & core settings
# #######################################
-D
-b 8192
-f 1
-r 0

# #######################################
# Audit self-protection / config
# #######################################
-w /etc/audit/      -p wa -k audit_config
-w /var/log/audit/  -p wa -k audit_logs

# #######################################
# Identity & auth
# #######################################
-w /etc/passwd   -p wa -k identity
-w /etc/group    -p wa -k identity
-w /etc/shadow   -p wa -k identity
-w /etc/gshadow  -p wa -k identity
-w /etc/security/opasswd -p wa -k identity

# sudo config
-w /etc/sudoers    -p wa -k sudo_config
-w /etc/sudoers.d/ -p wa -k sudo_config

# #######################################
# Time changes
# #######################################
-a always,exit -F arch=b64 -S adjtimex,settimeofday,clock_settime -k time_change
-a always,exit -F arch=b32 -S adjtimex,settimeofday,clock_settime -k time_change
-w /etc/localtime -p wa -k time_change

# #######################################
# Network configuration changes
# #######################################
-a always,exit -F arch=b64 -S sethostname,setdomainname -k net_change
-a always,exit -F arch=b32 -S sethostname,setdomainname -k net_change
-w /etc/hosts       -p wa -k net_change
-w /etc/hostname    -p wa -k net_change
-w /etc/resolv.conf -p wa -k net_change
-w /etc/netplan/    -p wa -k net_change
-w /etc/network/    -p wa -k net_change

# SSH config
-w /etc/ssh/sshd_config     -p wa -k ssh_config
-w /etc/ssh/ssh_config      -p wa -k ssh_config
-w /etc/ssh/sshd_config.d/  -p wa -k ssh_config
-w /etc/ssh/ssh_config.d/   -p wa -k ssh_config

# #######################################
# Session / logins (utmp/wtmp/btmp)
# #######################################
-w /var/run/utmp   -p wa -k session
-w /var/log/wtmp   -p wa -k session
-w /var/log/btmp   -p wa -k session
-w /var/log/lastlog -p wa -k session

# #######################################
# Privilege escalation (execution signals)
# #######################################
# Explicit binaries
-w /usr/bin/sudo -p x -k priv_cmd
-w /bin/su      -p x -k priv_cmd

# "Not audit-aware" escalation vectors
-a always,exit -F arch=b32 -F path=/usr/bin/systemd-run -F perm=x -F auid!=unset -k maybe_escalation
-a always,exit -F arch=b64 -F path=/usr/bin/systemd-run -F perm=x -F auid!=unset -k maybe_escalation
-a always,exit -F arch=b32 -F path=/usr/bin/pkexec     -F perm=x -F auid!=unset -k maybe_escalation
-a always,exit -F arch=b64 -F path=/usr/bin/pkexec     -F perm=x -F auid!=unset -k maybe_escalation

# Any exec as root by a real user (uid>=1000)
-a always,exit -F arch=b64 -S execve -F euid=0 -F auid>=1000 -F auid!=unset -k root_exec
-a always,exit -F arch=b32 -S execve -F euid=0 -F auid>=1000 -F auid!=unset -k root_exec

# Priv change patterns (uid != euid)
-a always,exit -F arch=b64 -S execve -C uid!=euid -k priv_esc
-a always,exit -F arch=b32 -S execve -C uid!=euid -k priv_esc

# #######################################
# Mount operations
# #######################################
-a always,exit -F arch=b64 -S mount,umount2 -F auid>=1000 -F auid!=unset -k mounts
-a always,exit -F arch=b32 -S mount,umount2 -F auid>=1000 -F auid!=unset -k mounts

# #######################################
# Kernel modules
# #######################################
-a always,exit -F arch=b64 -S init_module,finit_module,delete_module -k kernel_modules
-a always,exit -F arch=b32 -S init_module,finit_module,delete_module -k kernel_modules
-w /sbin/insmod   -p x -k kernel_modules
-w /sbin/rmmod    -p x -k kernel_modules
-w /sbin/modprobe -p x -k kernel_modules

# #######################################
# Cron / scheduled tasks
# #######################################
-w /etc/crontab                 -p wa -k cron
-w /etc/cron.d/                 -p wa -k cron
-w /etc/cron.daily/             -p wa -k cron
-w /etc/cron.hourly/            -p wa -k cron
-w /etc/cron.weekly/            -p wa -k cron
-w /etc/cron.monthly/           -p wa -k cron
-w /var/spool/cron/crontabs/    -p wa -k cron

# #######################################
# User/group management tools
# #######################################
-w /usr/bin/passwd     -p x -k passwd_mod
-w /usr/sbin/useradd   -p x -k user_mgmt
-w /usr/sbin/usermod   -p x -k user_mgmt
-w /usr/sbin/adduser   -p x -k user_mgmt
-w /usr/sbin/groupadd  -p x -k group_mgmt
-w /usr/sbin/groupmod  -p x -k group_mgmt
-w /usr/sbin/addgroup  -p x -k group_mgmt

# #######################################
# Anonymous file creation (memfd)
# #######################################
-a always,exit -F arch=b64 -S memfd_create -k anon_file_create
-a always,exit -F arch=b32 -S memfd_create -k anon_file_create

# #######################################
# File deletion (accountability)
# #######################################
-a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat,rmdir -F auid>=1000 -F auid!=unset -k delete
-a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat,rmdir -F auid>=1000 -F auid!=unset -k delete

# #######################################
# Unsuccessful access (generic catch-all) - keep late
# (Includes openat2/open_by_handle_at; remove if unsupported)
# #######################################
-a always,exit -F arch=b32 -S open,openat,openat2,open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=unset -k unsuccessful_access
-a always,exit -F arch=b64 -S open,openat,openat2,open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=unset -k unsuccessful_access
-a always,exit -F arch=b32 -S open,openat,openat2,open_by_handle_at -F exit=-EPERM  -F auid>=1000 -F auid!=unset -k unsuccessful_access
-a always,exit -F arch=b64 -S open,openat,openat2,open_by_handle_at -F exit=-EPERM  -F auid>=1000 -F auid!=unset -k unsuccessful_access

# #######################################
# Make rules immutable (reboot to change)
# #######################################
-e 2